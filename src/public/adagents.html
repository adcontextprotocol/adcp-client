<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdAgents.json Manager - AdCP Testing Framework</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        /* CSS Custom Properties for Theming */
        :root {
            /* Primary gradients */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --danger-gradient: linear-gradient(135deg, #fc466b 0%, #3f5efb 100%);
            
            /* Glass morphism effects */
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            
            /* Semantic colors */
            --surface-primary: rgba(255, 255, 255, 0.95);
            --surface-secondary: rgba(248, 250, 252, 0.8);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            
            /* Interactive colors */
            --accent-blue: #4299e1;
            --accent-purple: #9f7aea;
            --accent-green: #48bb78;
            --accent-orange: #ed8936;
            
            /* Animation timing */
            --timing-fast: 0.2s;
            --timing-normal: 0.4s;
            --timing-slow: 0.6s;
            --easing: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Modern Typography System */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            line-height: 1.6;
            color: var(--text-primary);
            font-weight: 400;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
        }

        /* Background Elements */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: 1;
        }

        /* Top Navigation */
        .top-nav {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 60px;
        }

        .nav-brand h2 {
            color: white;
            margin: 0;
            font-size: 18px;
            font-weight: 600;
        }

        .nav-links {
            display: flex;
            gap: 30px;
        }

        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
        }

        .nav-link:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-1px);
        }

        .nav-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            position: relative;
            z-index: 2;
        }

        /* Page Header */
        .page-header {
            text-align: center;
            margin-bottom: 50px;
        }

        .page-header h1 {
            color: white;
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .page-header p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            margin: 0;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Glass-morphic Card Design */
        .section {
            background: var(--surface-primary);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                0 1px 3px rgba(0, 0, 0, 0.12);
            transition: all var(--timing-normal) var(--easing);
            position: relative;
            overflow: hidden;
        }

        .section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            border-radius: 16px 16px 0 0;
        }

        .section h3 {
            color: var(--text-primary);
            margin: 0 0 20px 0;
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section h4 {
            color: var(--text-secondary);
            margin: 0 0 15px 0;
            font-size: 1.2rem;
            font-weight: 600;
        }

        /* Modern Button System */
        .btn {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all var(--timing-fast) var(--easing);
            text-decoration: none;
            display: inline-block;
            text-align: center;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
            box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 4px 16px rgba(108, 117, 125, 0.4);
        }

        /* Form Elements */
        input[type="text"], input[type="url"], textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: all var(--timing-fast) var(--easing);
            font-family: inherit;
            box-sizing: border-box;
        }

        input[type="text"]:focus, input[type="url"]:focus, textarea:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Monaco', 'Courier New', monospace;
        }

        /* Agent Entry Styling */
        .agent-entry {
            margin-bottom: 16px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
            transition: all var(--timing-fast) var(--easing);
        }

        .agent-entry:hover {
            border-color: var(--accent-blue);
            background: #f1f5f9;
        }

        .agent-entry-header {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .agent-entry-header input {
            margin: 0;
        }

        .agent-entry-header .btn {
            padding: 8px 12px;
            margin: 0;
        }

        .properties-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
            display: none;
        }

        .properties-section.visible {
            display: block;
        }

        .properties-section h5 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .property-entry {
            display: grid;
            grid-template-columns: 1fr 2fr 2fr auto;
            gap: 8px;
            margin-bottom: 8px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }

        .property-entry input, .property-entry select {
            padding: 6px 8px;
            font-size: 13px;
        }

        .property-entry .btn {
            padding: 6px 10px;
            font-size: 12px;
        }

        .properties-toggle {
            display: inline-block;
            margin-top: 8px;
            padding: 6px 12px;
            font-size: 13px;
            color: var(--accent-blue);
            background: #eff6ff;
            border: 1px solid #dbeafe;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .properties-toggle:hover {
            background: #dbeafe;
        }

        /* Results Display */
        .validation-result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .result-success {
            background: #f0fdf4;
            border-color: #bbf7d0;
            color: #166534;
        }

        .result-warning {
            background: #fffbeb;
            border-color: #fcd34d;
            color: #92400e;
        }

        .result-error {
            background: #fef2f2;
            border-color: #fca5a5;
            color: #dc2626;
        }

        /* JSON Output */
        .json-output-container {
            position: relative;
            margin-top: 20px;
        }

        .json-output {
            width: 100%;
            height: 300px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
            resize: vertical;
            box-sizing: border-box;
        }

        .copy-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-content {
                padding: 20px 10px;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .section {
                padding: 20px;
            }

            .agent-entry {
                flex-direction: column;
                gap: 8px;
            }

            .nav-container {
                padding: 0 15px;
            }

            .nav-links {
                gap: 15px;
            }

            .nav-link {
                padding: 6px 12px;
                font-size: 13px;
            }
        }

        @media (max-width: 480px) {
            .page-header h1 {
                font-size: 1.8rem;
            }

            .section {
                padding: 16px;
                margin-bottom: 20px;
            }

            .btn {
                padding: 10px 16px;
                font-size: 13px;
            }
        }

        /* Loading States */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .mb-1 { margin-bottom: 8px; }
        .mb-2 { margin-bottom: 16px; }
        .mb-3 { margin-bottom: 24px; }
        .flex { display: flex; }
        .gap-2 { gap: 8px; }
        .gap-3 { gap: 12px; }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="nav-container">
            <div class="nav-brand">
                <h2>AdCP Testing Framework</h2>
            </div>
            <div class="nav-links">
                <a href="/" class="nav-link">üß™ Media Buy Testing</a>
                <a href="/creative-testing.html" class="nav-link">üé® Creative Agent Testing</a>
                <a href="/adagents.html" class="nav-link active">üîó AdAgents Manager</a>
            </div>
        </div>
    </nav>

    <div class="main-content">
        <!-- Page Header -->
        <div class="page-header">
            <h1>üîó AdAgents.json Manager</h1>
            <p>Validate, create, and manage adagents.json files for the Ad Context Protocol. Ensure your domain properly declares authorized sales agents according to the AdCP specification.</p>
        </div>

        <!-- Unified AdAgents.json Manager Section -->
        <div class="section">
            <h3 id="main-section-title">üîó Manage AdAgents.json</h3>
            <p id="main-section-description" style="color: #666; margin-bottom: 20px;">Enter your domain to create or update your adagents.json file. We'll automatically detect if you have an existing file and load it for editing.</p>

            <!-- Domain Input Step -->
            <div id="domain-input-step">
                <h4>Enter Your Domain</h4>
                <p style="color: #666; margin-bottom: 16px;">Start by entering your domain name. We'll check for existing configuration and help you create or update your adagents.json file.</p>
                <div style="display: flex; gap: 12px; margin-bottom: 20px;">
                    <input type="text" id="domain-input" placeholder="example.com" style="flex: 1;">
                    <button class="btn" onclick="startManaging()" id="start-btn">‚ñ∂Ô∏è Continue</button>
                </div>
            </div>

            <!-- Validation Results (shown after domain check) -->
            <div id="validation-status" style="display: none; margin-bottom: 20px;">
                <!-- Validation status will be shown here -->
            </div>
            
            <!-- Agent Creation Form (hidden initially) -->
            <div id="creator-form" style="display: none;">
                <!-- Personalized Deployment Instructions -->
                <div id="personalized-instructions" style="background: #e8f4fd; border: 1px solid #bee5eb; border-radius: 8px; padding: 16px; margin-bottom: 20px;">
                    <h4 style="margin: 0 0 12px 0; color: #0c5460;">üìç File Placement Instructions for <span id="user-domain-display"></span></h4>
                    <p style="margin: 0 0 8px 0; color: #0c5460;">After generating your adagents.json file, upload it to your domain's <code>/.well-known/</code> directory.</p>
                    <p style="margin: 0; color: #0c5460;">
                        <strong>Your file must be accessible at:</strong><br>
                        <code id="user-file-path" style="background: white; padding: 4px 8px; border-radius: 4px; color: #0c5460; font-weight: bold;"></code>
                    </p>
                </div>
                
                <h4 id="step-2-title">Step 2: Add Authorized Agents</h4>
                <div id="agents-list" style="margin-bottom: 20px;">
                    <div class="agent-entry">
                        <div class="agent-entry-header">
                            <input type="url" placeholder="https://agent.example.com" style="flex: 2;" class="agent-url">
                            <input type="text" placeholder="Authorized for all products and services" style="flex: 3;" class="agent-auth">
                            <button class="btn" onclick="removeAgentEntry(this)" style="background: #dc3545;">‚úñÔ∏è</button>
                        </div>
                        <div class="properties-toggle" onclick="toggleProperties(this)">
                            ‚ûï Add Properties (optional)
                        </div>
                        <div class="properties-section">
                            <h5>Properties for this agent:</h5>
                            <div class="properties-list"></div>
                            <button class="btn btn-secondary" onclick="addProperty(this)" style="margin-top: 8px; padding: 6px 12px; font-size: 13px;">‚ûï Add Property</button>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button class="btn" onclick="addAgentEntry()">‚ûï Add Agent</button>
                    <button class="btn" onclick="loadExampleAgents()">üìÑ Load Example</button>
                    <button class="btn" onclick="generateAdAgentsJson()" id="generate-btn">üöÄ Generate JSON</button>
                    <button class="btn btn-secondary" onclick="validateAgentCards()" id="validate-cards-btn" style="display: none;">üîç Validate Cards</button>
                </div>
                
                <div id="generated-json" style="display: none;">
                    <h4>Generated adagents.json for <span id="generated-domain-display"></span></h4>
                    <div class="json-output-container">
                        <textarea id="json-output" class="json-output" readonly></textarea>
                        <button class="btn copy-btn" onclick="copyToClipboard('json-output')">üìã Copy</button>
                    </div>
                    <div style="margin-top: 16px; display: flex; gap: 12px;">
                        <button class="btn" onclick="downloadAdAgentsJson()">üíæ Download File</button>
                        <button class="btn btn-secondary" onclick="clearGenerated()">üóëÔ∏è Clear</button>
                    </div>
                    <div id="personalized-reminder" style="margin-top: 12px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 6px;">
                        <p style="margin: 0; font-size: 14px; color: #856404;">
                            <strong>üìç Next Step:</strong> Upload this file to <code id="reminder-file-path"></code> to make it discoverable by the AdCP protocol.
                        </p>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; gap: 12px;">
                    <button class="btn btn-secondary" onclick="resetCreator()">‚¨ÖÔ∏è Back to Domain Entry</button>
                </div>
            </div>
            
            <div id="agent-cards-results" style="display: none; margin-top: 20px;">
                <!-- Agent card validation results will be shown here -->
            </div>
        </div>

        <!-- Documentation Section -->
        <div class="section">
            <h3>üìö AdCP Specification</h3>
            <p style="color: #666; margin-bottom: 16px;">The adagents.json file must be hosted at <code>/.well-known/adagents.json</code> and follow the AdCP specification:</p>
            
            <div style="background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0;">
                <h4>Required Structure:</h4>
                <pre style="background: #1a202c; color: #f7fafc; padding: 16px; border-radius: 8px; overflow-x: auto; font-size: 13px;">{
  "$schema": "https://adcontextprotocol.org/schemas/v1/adagents.json",
  "authorized_agents": [
    {
      "url": "https://agent.example.com",
      "authorized_for": "Description of authorization scope"
    }
  ],
  "last_updated": "2025-01-10T12:00:00Z"
}</pre>
                
                <div style="margin-top: 16px;">
                    <h4>Key Requirements:</h4>
                    <ul style="margin: 8px 0; padding-left: 20px;">
                        <li><strong>HTTPS Required:</strong> All agent URLs must use HTTPS</li>
                        <li><strong>Authorization Scope:</strong> 1-500 characters describing what each agent is authorized to do</li>
                        <li><strong>Domain Matching:</strong> Agents validate authorization based on publisher domain</li>
                        <li><strong>Agent Cards:</strong> Each agent should provide a valid agent card at their endpoint</li>
                    </ul>
                </div>
                
                <div style="margin-top: 16px;">
                    <p style="color: #666; font-size: 14px; margin: 0;">
                        <strong>Note:</strong> This tool validates against the AdCP adagents.json specification. 
                        The structure and requirements shown above reflect the current protocol standards.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // AdAgents.json Management Functions
        // ============================================================================

        async function startManaging() {
            const domain = document.getElementById('domain-input').value.trim();
            const startBtn = document.getElementById('start-btn');
            const statusDiv = document.getElementById('validation-status');

            if (!domain) {
                alert('Please enter a domain name');
                return;
            }

            // Normalize domain
            const normalizedDomain = domain.replace(/^https?:\/\//, '').replace(/^www\./, '').replace(/\/$/, '');

            startBtn.disabled = true;
            startBtn.textContent = 'üîÑ Checking domain...';
            statusDiv.style.display = 'none';

            try {
                console.log(`Checking adagents.json for domain: ${normalizedDomain}`);

                const response = await fetch('/api/adagents/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ domain: normalizedDomain })
                });

                const result = await response.json();
                let isUpdate = false;
                let existingAgents = [];
                let statusHtml = '';

                if (result.success && result.data.found) {
                    if (result.data.validation.valid) {
                        // Valid adagents.json exists - this is an update
                        isUpdate = true;
                        if (result.data.validation.raw_data && result.data.validation.raw_data.authorized_agents) {
                            existingAgents = result.data.validation.raw_data.authorized_agents;
                        }
                        statusHtml = `
                            <div style="background: #d1fae5; border: 1px solid #6ee7b7; border-radius: 8px; padding: 16px;">
                                <strong style="color: #065f46;">‚úÖ Found existing adagents.json</strong><br>
                                <span style="color: #047857;">Found ${existingAgents.length} agent(s). Edit them below or add new ones.</span>
                            </div>
                        `;
                        console.log(`Found existing valid adagents.json with ${existingAgents.length} agents`);
                    } else {
                        // Invalid adagents.json found
                        statusHtml = `
                            <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 8px; padding: 16px;">
                                <strong style="color: #92400e;">‚ö†Ô∏è Found invalid adagents.json</strong><br>
                                <span style="color: #b45309;">Your existing file has errors. Let's create a new valid one.</span>
                            </div>
                        `;
                        console.log('Found invalid adagents.json - will create new file');
                    }
                } else {
                    // No adagents.json found
                    statusHtml = `
                        <div style="background: #e0e7ff; border: 1px solid #a5b4fc; border-radius: 8px; padding: 16px;">
                            <strong style="color: #3730a3;">üìù No adagents.json found</strong><br>
                            <span style="color: #4f46e5;">Let's create one for your domain.</span>
                        </div>
                    `;
                    console.log('No adagents.json found - will create new file');
                }

                statusDiv.innerHTML = statusHtml;
                statusDiv.style.display = 'block';

                // Update UI based on create vs update mode
                updateUIForMode(normalizedDomain, isUpdate, existingAgents);

                // Hide domain step, show creation form
                document.getElementById('domain-input-step').style.display = 'none';
                document.getElementById('creator-form').style.display = 'block';

                startBtn.disabled = false;
                startBtn.textContent = '‚ñ∂Ô∏è Continue';

            } catch (error) {
                console.error(`Error checking domain: ${error.message}`);
                statusDiv.innerHTML = `
                    <div style="background: #fee2e2; border: 1px solid #fca5a5; border-radius: 8px; padding: 16px;">
                        <strong style="color: #991b1b;">‚ùå Error checking domain</strong><br>
                        <span style="color: #dc2626;">${error.message}</span><br>
                        <span style="color: #7f1d1d;">Continuing in create mode...</span>
                    </div>
                `;
                statusDiv.style.display = 'block';

                // On error, default to create mode
                updateUIForMode(normalizedDomain, false, []);

                // Hide domain step, show creation form
                document.getElementById('domain-input-step').style.display = 'none';
                document.getElementById('creator-form').style.display = 'block';

                startBtn.disabled = false;
                startBtn.textContent = '‚ñ∂Ô∏è Continue';
            }
        }

        function updateUIForMode(normalizedDomain, isUpdate, existingAgents) {
            // Update section title
            const sectionTitle = document.getElementById('main-section-title');

            if (isUpdate) {
                sectionTitle.innerHTML = 'üìù Update AdAgents.json';
            } else {
                sectionTitle.innerHTML = 'üìù Create AdAgents.json';
            }

            // Update personalized instructions
            document.getElementById('user-domain-display').textContent = normalizedDomain;
            document.getElementById('user-file-path').textContent = `https://${normalizedDomain}/.well-known/adagents.json`;
            document.getElementById('generated-domain-display').textContent = normalizedDomain;
            document.getElementById('reminder-file-path').textContent = `https://${normalizedDomain}/.well-known/adagents.json`;

            // Pre-populate agents if updating
            if (isUpdate && existingAgents.length > 0) {
                const agentsList = document.getElementById('agents-list');
                agentsList.innerHTML = '';

                existingAgents.forEach(agent => {
                    const newEntry = document.createElement('div');
                    newEntry.className = 'agent-entry';

                    const hasProperties = agent.properties && agent.properties.length > 0;

                    newEntry.innerHTML = `
                        <div class="agent-entry-header">
                            <input type="url" placeholder="https://agent.example.com" style="flex: 2;" class="agent-url" value="${agent.url}">
                            <input type="text" placeholder="Authorized for all products and services" style="flex: 3;" class="agent-auth" value="${agent.authorized_for}">
                            <button class="btn" onclick="removeAgentEntry(this)" style="background: #dc3545;">‚úñÔ∏è</button>
                        </div>
                        <div class="properties-toggle" onclick="toggleProperties(this)">
                            ${hasProperties ? '‚ûñ Hide Properties' : '‚ûï Add Properties (optional)'}
                        </div>
                        <div class="properties-section ${hasProperties ? 'visible' : ''}">
                            <h5>Properties for this agent:</h5>
                            <div class="properties-list"></div>
                            <button class="btn btn-secondary" onclick="addProperty(this)" style="margin-top: 8px; padding: 6px 12px; font-size: 13px;">‚ûï Add Property</button>
                        </div>
                    `;

                    agentsList.appendChild(newEntry);

                    // Add existing properties
                    if (hasProperties) {
                        const propertiesList = newEntry.querySelector('.properties-list');
                        agent.properties.forEach(prop => {
                            const propertyEntry = document.createElement('div');
                            propertyEntry.className = 'property-entry';
                            const identifier = prop.identifiers && prop.identifiers[0] ? `${prop.identifiers[0].type}:${prop.identifiers[0].value}` : '';
                            propertyEntry.innerHTML = `
                                <select class="property-type">
                                    <option value="website" ${prop.property_type === 'website' ? 'selected' : ''}>Website</option>
                                    <option value="mobile_app" ${prop.property_type === 'mobile_app' ? 'selected' : ''}>Mobile App</option>
                                    <option value="ctv_app" ${prop.property_type === 'ctv_app' ? 'selected' : ''}>CTV App</option>
                                    <option value="dooh" ${prop.property_type === 'dooh' ? 'selected' : ''}>DOOH</option>
                                    <option value="podcast" ${prop.property_type === 'podcast' ? 'selected' : ''}>Podcast</option>
                                    <option value="radio" ${prop.property_type === 'radio' ? 'selected' : ''}>Radio</option>
                                    <option value="streaming_audio" ${prop.property_type === 'streaming_audio' ? 'selected' : ''}>Streaming Audio</option>
                                </select>
                                <input type="text" placeholder="Property name" class="property-name" value="${prop.name || ''}">
                                <input type="text" placeholder="domain:example.com or type:value" class="property-identifier" value="${identifier}">
                                <button class="btn" onclick="removeProperty(this)" style="background: #dc3545;">‚úñÔ∏è</button>
                            `;
                            propertiesList.appendChild(propertyEntry);
                        });
                    }
                });

                console.log(`Pre-populated ${existingAgents.length} existing agents for update`);
            }

            // Update step 2 title
            const step2Title = document.getElementById('step-2-title');
            if (isUpdate) {
                step2Title.textContent = 'Step 2: Update Authorized Agents';
            } else {
                step2Title.textContent = 'Step 2: Add Authorized Agents';
            }
        }

        // Legacy function - keeping for backward compatibility (not used anymore)
        function displayValidationResults(data) {
            const { domain, found, validation, agent_cards } = data;

            let html = `<h4>Validation Results for ${domain}</h4>`;

            // Overall status
            if (found && validation.valid) {
                html += `
                    <div class="validation-result result-success">
                        <strong>‚úÖ Valid AdAgents.json Found</strong><br>
                        Found at: <code>${validation.url}</code>
                    </div>
                `;
            } else if (found && !validation.valid) {
                html += `
                    <div class="validation-result result-warning">
                        <strong>‚ö†Ô∏è AdAgents.json Found but Invalid</strong><br>
                        Found at: <code>${validation.url}</code>
                    </div>
                `;
            } else {
                html += `
                    <div class="validation-result result-error">
                        <strong>‚ùå No AdAgents.json Found</strong><br>
                        Expected at: <code>https://${domain}/.well-known/adagents.json</code>
                    </div>
                `;
            }

            // Validation errors and warnings
            if (validation.errors.length > 0 || validation.warnings.length > 0) {
                html += '<div style="margin-top: 20px;">';
                
                if (validation.errors.length > 0) {
                    html += '<h5>‚ùå Errors:</h5><ul style="margin-bottom: 10px;">';
                    validation.errors.forEach(error => {
                        html += `<li style="color: #dc2626;"><strong>${error.field}:</strong> ${error.message}</li>`;
                    });
                    html += '</ul>';
                }

                if (validation.warnings.length > 0) {
                    html += '<h5>‚ö†Ô∏è Warnings:</h5><ul>';
                    validation.warnings.forEach(warning => {
                        html += `<li style="color: #92400e;"><strong>${warning.field}:</strong> ${warning.message}`;
                        if (warning.suggestion) {
                            html += `<br><em>Suggestion: ${warning.suggestion}</em>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                }
                html += '</div>';
            }

            // Agent cards validation
            if (agent_cards && agent_cards.length > 0) {
                html += '<h5>üîç Agent Card Validation:</h5>';
                html += '<div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">';
                
                agent_cards.forEach(card => {
                    const status = card.valid ? '‚úÖ' : '‚ùå';
                    const statusColor = card.valid ? '#166534' : '#dc2626';
                    
                    // Extract agent name from card data if available
                    let agentName = '';
                    if (card.valid && card.card_data && card.card_data.name) {
                        agentName = ` - ${card.card_data.name}`;
                    }
                    
                    // Show which endpoint was used for successful validations
                    let endpointInfo = '';
                    if (card.valid && card.card_endpoint) {
                        const endpointPath = card.card_endpoint.replace(card.agent_url, '');
                        if (endpointPath === '/.well-known/agent-card.json') {
                            endpointInfo = ' <span style="color: #059669; font-size: 11px;">[A2A]</span>';
                        } else if (endpointPath === '') {
                            endpointInfo = ' <span style="color: #7c3aed; font-size: 11px;">[Root]</span>';
                        } else {
                            endpointInfo = ` <span style="color: #7c3aed; font-size: 11px;">[${endpointPath}]</span>`;
                        }
                    }
                    
                    html += `
                        <div style="margin-bottom: 10px; padding: 12px; border-left: 4px solid ${statusColor}; background: white; border-radius: 4px;">
                            <strong>${status} ${card.agent_url}${agentName}</strong>${endpointInfo}
                            ${card.response_time_ms ? `<span style="color: #666; font-size: 12px;"> (${card.response_time_ms}ms)</span>` : ''}
                            ${card.status_code ? `<br><em>HTTP ${card.status_code}</em>` : ''}
                            ${card.errors.length > 0 ? `<br><span style="color: #dc2626;">Errors: ${card.errors.join(', ')}</span>` : ''}
                        </div>
                    `;
                });
                html += '</div>';
            }

            // Raw data
            if (validation.raw_data) {
                html += `
                    <details style="margin-top: 20px;">
                        <summary style="cursor: pointer; font-weight: bold; color: var(--text-secondary);">üìÑ Raw AdAgents.json Data</summary>
                        <pre style="background: #1a202c; color: #f7fafc; padding: 16px; border-radius: 8px; margin-top: 12px; font-size: 12px; overflow-x: auto;">${JSON.stringify(validation.raw_data, null, 2)}</pre>
                    </details>
                `;
            }

            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function addAgentEntry() {
            const agentsList = document.getElementById('agents-list');
            const newEntry = document.createElement('div');
            newEntry.className = 'agent-entry';

            newEntry.innerHTML = `
                <div class="agent-entry-header">
                    <input type="url" placeholder="https://agent.example.com" style="flex: 2;" class="agent-url">
                    <input type="text" placeholder="Authorized for all products and services" style="flex: 3;" class="agent-auth">
                    <button class="btn" onclick="removeAgentEntry(this)" style="background: #dc3545;">‚úñÔ∏è</button>
                </div>
                <div class="properties-toggle" onclick="toggleProperties(this)">
                    ‚ûï Add Properties (optional)
                </div>
                <div class="properties-section">
                    <h5>Properties for this agent:</h5>
                    <div class="properties-list"></div>
                    <button class="btn btn-secondary" onclick="addProperty(this)" style="margin-top: 8px; padding: 6px 12px; font-size: 13px;">‚ûï Add Property</button>
                </div>
            `;

            agentsList.appendChild(newEntry);
        }

        function removeAgentEntry(button) {
            const agentsList = document.getElementById('agents-list');
            if (agentsList.children.length > 1) {
                button.closest('.agent-entry').remove();
            } else {
                alert('At least one agent is required');
            }
        }

        function toggleProperties(toggleButton) {
            const agentEntry = toggleButton.closest('.agent-entry');
            const propertiesSection = agentEntry.querySelector('.properties-section');

            if (propertiesSection.classList.contains('visible')) {
                propertiesSection.classList.remove('visible');
                toggleButton.textContent = '‚ûï Add Properties (optional)';
            } else {
                propertiesSection.classList.add('visible');
                toggleButton.textContent = '‚ûñ Hide Properties';
            }
        }

        function addProperty(button) {
            const propertiesList = button.closest('.properties-section').querySelector('.properties-list');
            const propertyEntry = document.createElement('div');
            propertyEntry.className = 'property-entry';

            propertyEntry.innerHTML = `
                <select class="property-type">
                    <option value="website">Website</option>
                    <option value="mobile_app">Mobile App</option>
                    <option value="ctv_app">CTV App</option>
                    <option value="dooh">DOOH</option>
                    <option value="podcast">Podcast</option>
                    <option value="radio">Radio</option>
                    <option value="streaming_audio">Streaming Audio</option>
                </select>
                <input type="text" placeholder="Property name" class="property-name">
                <input type="text" placeholder="domain:example.com or type:value" class="property-identifier">
                <button class="btn" onclick="removeProperty(this)" style="background: #dc3545;">‚úñÔ∏è</button>
            `;

            propertiesList.appendChild(propertyEntry);
        }

        function removeProperty(button) {
            button.closest('.property-entry').remove();
        }

        function loadExampleAgents() {
            // Clear existing entries
            const agentsList = document.getElementById('agents-list');
            agentsList.innerHTML = '';

            // Add example entries
            const examples = [
                {
                    url: 'https://test-agent.adcontextprotocol.org',
                    auth: 'Authorized for all display and video advertising products',
                    properties: [
                        { type: 'website', name: 'Main Site', identifier: 'domain:example.com' }
                    ]
                },
                {
                    url: 'https://agent2.example.com',
                    auth: 'Authorized for premium inventory and high-value campaigns only',
                    properties: []
                }
            ];

            examples.forEach(example => {
                const newEntry = document.createElement('div');
                newEntry.className = 'agent-entry';

                newEntry.innerHTML = `
                    <div class="agent-entry-header">
                        <input type="url" placeholder="https://agent.example.com" style="flex: 2;" class="agent-url" value="${example.url}">
                        <input type="text" placeholder="Authorized for all products and services" style="flex: 3;" class="agent-auth" value="${example.auth}">
                        <button class="btn" onclick="removeAgentEntry(this)" style="background: #dc3545;">‚úñÔ∏è</button>
                    </div>
                    <div class="properties-toggle" onclick="toggleProperties(this)">
                        ‚ûï Add Properties (optional)
                    </div>
                    <div class="properties-section ${example.properties.length > 0 ? 'visible' : ''}">
                        <h5>Properties for this agent:</h5>
                        <div class="properties-list"></div>
                        <button class="btn btn-secondary" onclick="addProperty(this)" style="margin-top: 8px; padding: 6px 12px; font-size: 13px;">‚ûï Add Property</button>
                    </div>
                `;

                agentsList.appendChild(newEntry);

                // Add example properties if any
                if (example.properties.length > 0) {
                    const propertiesList = newEntry.querySelector('.properties-list');
                    const toggle = newEntry.querySelector('.properties-toggle');
                    toggle.textContent = '‚ûñ Hide Properties';

                    example.properties.forEach(prop => {
                        const propertyEntry = document.createElement('div');
                        propertyEntry.className = 'property-entry';
                        propertyEntry.innerHTML = `
                            <select class="property-type">
                                <option value="website" ${prop.type === 'website' ? 'selected' : ''}>Website</option>
                                <option value="mobile_app" ${prop.type === 'mobile_app' ? 'selected' : ''}>Mobile App</option>
                                <option value="ctv_app" ${prop.type === 'ctv_app' ? 'selected' : ''}>CTV App</option>
                                <option value="dooh" ${prop.type === 'dooh' ? 'selected' : ''}>DOOH</option>
                                <option value="podcast" ${prop.type === 'podcast' ? 'selected' : ''}>Podcast</option>
                                <option value="radio" ${prop.type === 'radio' ? 'selected' : ''}>Radio</option>
                                <option value="streaming_audio" ${prop.type === 'streaming_audio' ? 'selected' : ''}>Streaming Audio</option>
                            </select>
                            <input type="text" placeholder="Property name" class="property-name" value="${prop.name}">
                            <input type="text" placeholder="domain:example.com or type:value" class="property-identifier" value="${prop.identifier}">
                            <button class="btn" onclick="removeProperty(this)" style="background: #dc3545;">‚úñÔ∏è</button>
                        `;
                        propertiesList.appendChild(propertyEntry);
                    });
                }
            });

            console.log('Loaded example adagents configuration with properties');
        }

        async function generateAdAgentsJson() {
            const agentEntries = document.querySelectorAll('.agent-entry');
            const authorizedAgents = [];

            for (const entry of agentEntries) {
                const url = entry.querySelector('.agent-url').value.trim();
                const authorizedFor = entry.querySelector('.agent-auth').value.trim();

                if (!url || !authorizedFor) {
                    alert('Please fill in all agent URL and authorization fields');
                    return;
                }

                // Collect properties for this agent
                const properties = [];
                const propertyEntries = entry.querySelectorAll('.property-entry');

                for (const propEntry of propertyEntries) {
                    const propertyType = propEntry.querySelector('.property-type').value;
                    const propertyName = propEntry.querySelector('.property-name').value.trim();
                    const identifierString = propEntry.querySelector('.property-identifier').value.trim();

                    if (propertyName && identifierString) {
                        // Parse identifier (format: "type:value")
                        const [idType, idValue] = identifierString.split(':').map(s => s.trim());

                        if (idType && idValue) {
                            properties.push({
                                property_type: propertyType,
                                name: propertyName,
                                identifiers: [{
                                    type: idType,
                                    value: idValue
                                }]
                            });
                        }
                    }
                }

                const agent = { url, authorized_for: authorizedFor };
                if (properties.length > 0) {
                    agent.properties = properties;
                }

                authorizedAgents.push(agent);
            }

            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.textContent = 'üîÑ Generating...';

            try {
                console.log(`Generating adagents.json with ${authorizedAgents.length} agents`);

                const response = await fetch('/api/adagents/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        authorized_agents: authorizedAgents,
                        include_schema: true,
                        include_timestamp: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    document.getElementById('json-output').value = result.data.adagents_json;
                    document.getElementById('generated-json').style.display = 'block';
                    document.getElementById('validate-cards-btn').style.display = 'inline-block';
                    
                    console.log('AdAgents.json generated successfully');
                    
                    // Show validation results if any issues
                    if (result.data.validation.warnings.length > 0) {
                        alert(`Generated successfully with ${result.data.validation.warnings.length} warnings. Check console for details.`);
                        console.warn('Validation warnings:', result.data.validation.warnings);
                    }
                } else {
                    throw new Error(result.error || 'Generation failed');
                }

            } catch (error) {
                console.error(`AdAgents.json generation failed: ${error.message}`);
                alert(`Generation failed: ${error.message}`);
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'üöÄ Generate JSON';
            }
        }

        async function validateAgentCards() {
            const agentUrls = Array.from(document.querySelectorAll('.agent-url')).map(input => input.value.trim()).filter(url => url);
            
            if (agentUrls.length === 0) {
                alert('No agent URLs to validate');
                return;
            }

            const validateBtn = document.getElementById('validate-cards-btn');
            validateBtn.disabled = true;
            validateBtn.textContent = 'üîÑ Validating...';

            try {
                console.log(`Validating ${agentUrls.length} agent cards`);

                const response = await fetch('/api/adagents/validate-cards', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ agent_urls: agentUrls })
                });

                const result = await response.json();

                if (result.success) {
                    displayAgentCardsResults(result.data.agent_cards);
                    console.log('Agent cards validation completed');
                } else {
                    throw new Error(result.error || 'Validation failed');
                }

            } catch (error) {
                console.error(`Agent cards validation failed: ${error.message}`);
                alert(`Validation failed: ${error.message}`);
            } finally {
                validateBtn.disabled = false;
                validateBtn.textContent = 'üîç Validate Cards';
            }
        }

        function displayAgentCardsResults(agentCards) {
            const resultsDiv = document.getElementById('agent-cards-results');
            
            let html = '<h4>Agent Cards Validation Results</h4>';
            html += '<div style="background: #f8fafc; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0;">';
            
            agentCards.forEach(card => {
                const status = card.valid ? '‚úÖ' : '‚ùå';
                const statusColor = card.valid ? '#166534' : '#dc2626';
                
                html += `
                    <div style="margin-bottom: 10px; padding: 12px; border-left: 4px solid ${statusColor}; background: white; border-radius: 4px;">
                        <strong>${status} ${card.agent_url}</strong>
                        ${card.response_time_ms ? `<span style="color: #666; font-size: 12px;"> (${card.response_time_ms}ms)</span>` : ''}
                        ${card.status_code ? `<br><em>HTTP ${card.status_code}</em>` : ''}
                        ${card.errors.length > 0 ? `<br><span style="color: #dc2626;">Issues: ${card.errors.join(', ')}</span>` : ''}
                        ${card.valid && card.card_data ? `<br><span style="color: #166534;">‚úÖ Agent card found and valid</span>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function copyToClipboard(textareaId) {
            const textarea = document.getElementById(textareaId);
            textarea.select();
            textarea.setSelectionRange(0, 99999); // For mobile devices
            
            try {
                document.execCommand('copy');
                // Provide visual feedback
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
                
                console.log('AdAgents.json copied to clipboard');
            } catch (err) {
                console.error('Failed to copy to clipboard:', err);
                alert('Failed to copy to clipboard');
            }
        }

        function downloadAdAgentsJson() {
            const jsonContent = document.getElementById('json-output').value;
            
            if (!jsonContent) {
                alert('No JSON content to download');
                return;
            }

            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'adagents.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('AdAgents.json file downloaded');
        }

        function clearGenerated() {
            document.getElementById('generated-json').style.display = 'none';
            document.getElementById('validate-cards-btn').style.display = 'none';
            document.getElementById('agent-cards-results').style.display = 'none';
            document.getElementById('json-output').value = '';
        }

        function resetCreator() {
            // Clear form data
            document.getElementById('domain-input').value = '';
            document.getElementById('json-output').value = '';
            document.getElementById('validation-status').style.display = 'none';

            // Reset agent entries to single default entry
            const agentsList = document.getElementById('agents-list');
            agentsList.innerHTML = `
                <div class="agent-entry">
                    <div class="agent-entry-header">
                        <input type="url" placeholder="https://agent.example.com" style="flex: 2;" class="agent-url">
                        <input type="text" placeholder="Authorized for all products and services" style="flex: 3;" class="agent-auth">
                        <button class="btn" onclick="removeAgentEntry(this)" style="background: #dc3545;">‚úñÔ∏è</button>
                    </div>
                    <div class="properties-toggle" onclick="toggleProperties(this)">
                        ‚ûï Add Properties (optional)
                    </div>
                    <div class="properties-section">
                        <h5>Properties for this agent:</h5>
                        <div class="properties-list"></div>
                        <button class="btn btn-secondary" onclick="addProperty(this)" style="margin-top: 8px; padding: 6px 12px; font-size: 13px;">‚ûï Add Property</button>
                    </div>
                </div>
            `;
            
            // Hide all sections except domain step
            document.getElementById('creator-form').style.display = 'none';
            document.getElementById('generated-json').style.display = 'none';
            document.getElementById('validate-cards-btn').style.display = 'none';
            document.getElementById('agent-cards-results').style.display = 'none';
            document.getElementById('domain-input-step').style.display = 'block';

            // Reset section title
            document.getElementById('main-section-title').innerHTML = 'üîó Manage AdAgents.json';

            console.log('Reset adagents.json manager to domain entry step');
        }

        // Initialize with one example agent entry
        document.addEventListener('DOMContentLoaded', function() {
            console.log('AdAgents.json Manager initialized');
        });
    </script>
</body>
</html>